/*
 * Copyright (c) 2016-2023 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { PLATFORM_ID } from '@angular/core';
import { Inject, Injectable } from '@angular/core';
import { uniqueIdFactory } from '../id-generator/id-generator.service';
import * as i0 from "@angular/core";
export var ClrAriaLivePoliteness;
(function (ClrAriaLivePoliteness) {
    ClrAriaLivePoliteness["off"] = "off";
    ClrAriaLivePoliteness["polite"] = "polite";
    ClrAriaLivePoliteness["assertive"] = "assertive";
})(ClrAriaLivePoliteness || (ClrAriaLivePoliteness = {}));
/**
 * Time in milliseconds before inserting the content into the container
 */
const ARIA_LIVE_TICK = 100;
/**
 * @deprecated
 *
 * -- ClrAriaLiveService is deprecated in 5.0 to be removed in 6.0 --
 * Please consider using the LiveAnnouncer in the Angular Material CDK
 * if your project needs this functionality.
 * More info: https://material.angular.io/cdk/a11y/overview#example-1
 *
 * This service handle `aria-live` accessibility attribute. The issue is that you need
 * to have the DOM Element with attribute `aria-live` before you could insert content
 * and SR (Screen Reader) pick the change and announce it.
 *
 * ```typescript
 * import { ClrAriaLiveService } from 'src/clr-angular/utils/a11y/aria-live.service';
 *
 * @Component({
 * selector: 'clr-demo-component',
 * providers: [ClrAriaLiveService],
 * template: `
 *   <ng-content></ng-content>
 * `,
 * })
 * export class DemoComponent {
 *  constructor(ariaLiveService: ClrAriaLiveService) {}
 *
 *  public actionThatWillTriggerChange() {
 *    this.ariaLiveService.announce('message that I want to announce to SR');
 *  }
 * }
 * ```
 *
 */
export class ClrAriaLiveService {
    constructor(ngZone, _document, platformId) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this._id = `clr-aria-live-element-${uniqueIdFactory()}`;
        this.document = _document;
    }
    /**
     * get access to the internal HTML `id` that gonna be used for the AriaLive container.
     * @return ID of the DOM Element as string.
     */
    get id() {
        return this._id;
    }
    /**
     * Append text content inside the AriaLive Container. This method will check if the
     * DOM Element is existing if not it will create one for us and the will apply the text.
     *
     * ```typescript
     * this.ariaLiveService.announce(this.el.nativeElement);
     * // or
     * this.ariaLiveService.announce('Message to announce to SR');
     * ```
     *
     * @remark
     * When second argument is `AriaLivePoliteness.off` we won't create aria container or update it.
     * The reason for that is that we don't want to do additional work if the SR will ignore it.
     *
     * @param message - This could be simple string or HTMLElement
     * @param politeness - 'polite', 'assertive' or 'off'
     */
    announce(message, politeness = ClrAriaLivePoliteness.polite) {
        if (politeness === ClrAriaLivePoliteness.off) {
            return;
        }
        if (!this.ariaLiveElement && isPlatformBrowser(this.platformId)) {
            this.ariaLiveElement = this.createContainer();
        }
        message = typeof message !== 'string' && isPlatformBrowser(this.platformId) ? message.textContent : message;
        // when there is no message do NOTHING!
        if (!message) {
            return;
        }
        this.ariaLiveElement.setAttribute('aria-live', politeness);
        // This 100ms timeout is necessary for some browser + screen-reader combinations:
        // - Both JAWS and NVDA over IE11 will not announce anything without a non-zero timeout.
        // - With Chrome and IE11 with NVDA or JAWS, a repeated (identical) message won't be read a
        //   second time without clearing and then using a non-zero delay.
        // (using JAWS 17 at time of this writing).
        this.ngZone.runOutsideAngular(() => {
            // This clearTimeout will stop all older messages from announcing
            // in the case where the messages are comming too fast we gonna try to append only
            // the last one. That's what the SR will try to do anyway.
            clearTimeout(this.previousTimeout);
            this.previousTimeout = setTimeout(() => {
                this.ariaLiveElement.textContent = message;
            }, ARIA_LIVE_TICK);
        });
    }
    /**
     * onDestroy life cycle - must stop all active setTimeouts and remove the AriaLive
     * container from the document.
     */
    ngOnDestroy() {
        clearTimeout(this.previousTimeout);
        if (isPlatformBrowser(this.platformId) && this.ariaLiveElement) {
            this.document.body.removeChild(this.ariaLiveElement);
            this.ariaLiveElement = null;
        }
    }
    /**
     * Create AriaLive DOM element as a last child of the document.
     * After the element is created, we gonna apply Clarity class to hide it from
     * the screen and set the `aria-live` politness.
     *
     * `clr-sr-only` is the CSS class that is used to hide the element from the screen.
     *
     * @remark
     * Calling this method multiple times will create multiple DOM Elements, that
     * won't be tracked and will be GC after the service is destroyed.
     *
     * @return AriaLive container as HTMLElement
     *
     */
    createContainer() {
        const ariaLiveElement = this.document.createElement('div');
        ariaLiveElement.setAttribute('id', this.id);
        // Use clarity screen reader class to hide the dom element
        // and fix the scrollbar shake
        ariaLiveElement.classList.add('clr-sr-only');
        ariaLiveElement.setAttribute('aria-atomic', 'true');
        ariaLiveElement.setAttribute('aria-live', ClrAriaLivePoliteness.polite);
        this.document.body.appendChild(ariaLiveElement);
        return ariaLiveElement;
    }
}
ClrAriaLiveService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: ClrAriaLiveService, deps: [{ token: i0.NgZone }, { token: DOCUMENT }, { token: PLATFORM_ID }], target: i0.ɵɵFactoryTarget.Injectable });
ClrAriaLiveService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: ClrAriaLiveService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: ClrAriaLiveService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJpYS1saXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyL3NyYy91dGlscy9hMTF5L2FyaWEtbGl2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFFdEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNDQUFzQyxDQUFDOztBQUV2RSxNQUFNLENBQU4sSUFBWSxxQkFJWDtBQUpELFdBQVkscUJBQXFCO0lBQy9CLG9DQUFXLENBQUE7SUFDWCwwQ0FBaUIsQ0FBQTtJQUNqQixnREFBdUIsQ0FBQTtBQUN6QixDQUFDLEVBSlcscUJBQXFCLEtBQXJCLHFCQUFxQixRQUloQztBQUVEOztHQUVHO0FBQ0gsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDO0FBRTNCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBK0JHO0FBSUgsTUFBTSxPQUFPLGtCQUFrQjtJQUs3QixZQUFvQixNQUFjLEVBQW9CLFNBQWMsRUFBK0IsVUFBZTtRQUE5RixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQWlFLGVBQVUsR0FBVixVQUFVLENBQUs7UUFJMUcsUUFBRyxHQUFHLHlCQUF5QixlQUFlLEVBQUUsRUFBRSxDQUFDO1FBSHpELElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDO0lBQzVCLENBQUM7SUFHRDs7O09BR0c7SUFDSCxJQUFJLEVBQUU7UUFDSixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7O09BZ0JHO0lBQ0gsUUFBUSxDQUFDLE9BQTZCLEVBQUUsYUFBb0MscUJBQXFCLENBQUMsTUFBTTtRQUN0RyxJQUFJLFVBQVUsS0FBSyxxQkFBcUIsQ0FBQyxHQUFHLEVBQUU7WUFDNUMsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQy9ELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1NBQy9DO1FBRUQsT0FBTyxHQUFHLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUU1Ryx1Q0FBdUM7UUFDdkMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUUzRCxpRkFBaUY7UUFDakYsd0ZBQXdGO1FBQ3hGLDJGQUEyRjtRQUMzRixrRUFBa0U7UUFDbEUsMkNBQTJDO1FBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFO1lBQ2pDLGlFQUFpRTtZQUNqRSxrRkFBa0Y7WUFDbEYsMERBQTBEO1lBQzFELFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLGVBQWUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNyQyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsR0FBRyxPQUFpQixDQUFDO1lBQ3ZELENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSCxXQUFXO1FBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNuQyxJQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7U0FDN0I7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNLLGVBQWU7UUFDckIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFM0QsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLDBEQUEwRDtRQUMxRCw4QkFBOEI7UUFDOUIsZUFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFN0MsZUFBZSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDcEQsZUFBZSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFeEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRWhELE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7O2dIQTdHVSxrQkFBa0Isd0NBS2UsUUFBUSxhQUEwQixXQUFXO29IQUw5RSxrQkFBa0IsY0FGakIsTUFBTTs0RkFFUCxrQkFBa0I7a0JBSDlCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFNc0MsTUFBTTsyQkFBQyxRQUFROzswQkFBbUIsTUFBTTsyQkFBQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxNi0yMDIzIFZNd2FyZSwgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogVGhpcyBzb2Z0d2FyZSBpcyByZWxlYXNlZCB1bmRlciBNSVQgbGljZW5zZS5cbiAqIFRoZSBmdWxsIGxpY2Vuc2UgaW5mb3JtYXRpb24gY2FuIGJlIGZvdW5kIGluIExJQ0VOU0UgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgcHJvamVjdC5cbiAqL1xuXG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgTmdab25lLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgdW5pcXVlSWRGYWN0b3J5IH0gZnJvbSAnLi4vaWQtZ2VuZXJhdG9yL2lkLWdlbmVyYXRvci5zZXJ2aWNlJztcblxuZXhwb3J0IGVudW0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzIHtcbiAgb2ZmID0gJ29mZicsXG4gIHBvbGl0ZSA9ICdwb2xpdGUnLFxuICBhc3NlcnRpdmUgPSAnYXNzZXJ0aXZlJyxcbn1cblxuLyoqXG4gKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgaW5zZXJ0aW5nIHRoZSBjb250ZW50IGludG8gdGhlIGNvbnRhaW5lclxuICovXG5jb25zdCBBUklBX0xJVkVfVElDSyA9IDEwMDtcblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICpcbiAqIC0tIENsckFyaWFMaXZlU2VydmljZSBpcyBkZXByZWNhdGVkIGluIDUuMCB0byBiZSByZW1vdmVkIGluIDYuMCAtLVxuICogUGxlYXNlIGNvbnNpZGVyIHVzaW5nIHRoZSBMaXZlQW5ub3VuY2VyIGluIHRoZSBBbmd1bGFyIE1hdGVyaWFsIENES1xuICogaWYgeW91ciBwcm9qZWN0IG5lZWRzIHRoaXMgZnVuY3Rpb25hbGl0eS5cbiAqIE1vcmUgaW5mbzogaHR0cHM6Ly9tYXRlcmlhbC5hbmd1bGFyLmlvL2Nkay9hMTF5L292ZXJ2aWV3I2V4YW1wbGUtMVxuICpcbiAqIFRoaXMgc2VydmljZSBoYW5kbGUgYGFyaWEtbGl2ZWAgYWNjZXNzaWJpbGl0eSBhdHRyaWJ1dGUuIFRoZSBpc3N1ZSBpcyB0aGF0IHlvdSBuZWVkXG4gKiB0byBoYXZlIHRoZSBET00gRWxlbWVudCB3aXRoIGF0dHJpYnV0ZSBgYXJpYS1saXZlYCBiZWZvcmUgeW91IGNvdWxkIGluc2VydCBjb250ZW50XG4gKiBhbmQgU1IgKFNjcmVlbiBSZWFkZXIpIHBpY2sgdGhlIGNoYW5nZSBhbmQgYW5ub3VuY2UgaXQuXG4gKlxuICogYGBgdHlwZXNjcmlwdFxuICogaW1wb3J0IHsgQ2xyQXJpYUxpdmVTZXJ2aWNlIH0gZnJvbSAnc3JjL2Nsci1hbmd1bGFyL3V0aWxzL2ExMXkvYXJpYS1saXZlLnNlcnZpY2UnO1xuICpcbiAqIEBDb21wb25lbnQoe1xuICogc2VsZWN0b3I6ICdjbHItZGVtby1jb21wb25lbnQnLFxuICogcHJvdmlkZXJzOiBbQ2xyQXJpYUxpdmVTZXJ2aWNlXSxcbiAqIHRlbXBsYXRlOiBgXG4gKiAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAqIGAsXG4gKiB9KVxuICogZXhwb3J0IGNsYXNzIERlbW9Db21wb25lbnQge1xuICogIGNvbnN0cnVjdG9yKGFyaWFMaXZlU2VydmljZTogQ2xyQXJpYUxpdmVTZXJ2aWNlKSB7fVxuICpcbiAqICBwdWJsaWMgYWN0aW9uVGhhdFdpbGxUcmlnZ2VyQ2hhbmdlKCkge1xuICogICAgdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ21lc3NhZ2UgdGhhdCBJIHdhbnQgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAqICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBDbHJBcmlhTGl2ZVNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGFyaWFMaXZlRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50O1xuICBwcml2YXRlIHByZXZpb3VzVGltZW91dDogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSwgQEluamVjdChET0NVTUVOVCkgX2RvY3VtZW50OiBhbnksIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogYW55KSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IF9kb2N1bWVudDtcbiAgfVxuXG4gIHByaXZhdGUgX2lkID0gYGNsci1hcmlhLWxpdmUtZWxlbWVudC0ke3VuaXF1ZUlkRmFjdG9yeSgpfWA7XG4gIC8qKlxuICAgKiBnZXQgYWNjZXNzIHRvIHRoZSBpbnRlcm5hbCBIVE1MIGBpZGAgdGhhdCBnb25uYSBiZSB1c2VkIGZvciB0aGUgQXJpYUxpdmUgY29udGFpbmVyLlxuICAgKiBAcmV0dXJuIElEIG9mIHRoZSBET00gRWxlbWVudCBhcyBzdHJpbmcuXG4gICAqL1xuICBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5faWQ7XG4gIH1cblxuICAvKipcbiAgICogQXBwZW5kIHRleHQgY29udGVudCBpbnNpZGUgdGhlIEFyaWFMaXZlIENvbnRhaW5lci4gVGhpcyBtZXRob2Qgd2lsbCBjaGVjayBpZiB0aGVcbiAgICogRE9NIEVsZW1lbnQgaXMgZXhpc3RpbmcgaWYgbm90IGl0IHdpbGwgY3JlYXRlIG9uZSBmb3IgdXMgYW5kIHRoZSB3aWxsIGFwcGx5IHRoZSB0ZXh0LlxuICAgKlxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIHRoaXMuYXJpYUxpdmVTZXJ2aWNlLmFubm91bmNlKHRoaXMuZWwubmF0aXZlRWxlbWVudCk7XG4gICAqIC8vIG9yXG4gICAqIHRoaXMuYXJpYUxpdmVTZXJ2aWNlLmFubm91bmNlKCdNZXNzYWdlIHRvIGFubm91bmNlIHRvIFNSJyk7XG4gICAqIGBgYFxuICAgKlxuICAgKiBAcmVtYXJrXG4gICAqIFdoZW4gc2Vjb25kIGFyZ3VtZW50IGlzIGBBcmlhTGl2ZVBvbGl0ZW5lc3Mub2ZmYCB3ZSB3b24ndCBjcmVhdGUgYXJpYSBjb250YWluZXIgb3IgdXBkYXRlIGl0LlxuICAgKiBUaGUgcmVhc29uIGZvciB0aGF0IGlzIHRoYXQgd2UgZG9uJ3Qgd2FudCB0byBkbyBhZGRpdGlvbmFsIHdvcmsgaWYgdGhlIFNSIHdpbGwgaWdub3JlIGl0LlxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSAtIFRoaXMgY291bGQgYmUgc2ltcGxlIHN0cmluZyBvciBIVE1MRWxlbWVudFxuICAgKiBAcGFyYW0gcG9saXRlbmVzcyAtICdwb2xpdGUnLCAnYXNzZXJ0aXZlJyBvciAnb2ZmJ1xuICAgKi9cbiAgYW5ub3VuY2UobWVzc2FnZTogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIHBvbGl0ZW5lc3M6IENsckFyaWFMaXZlUG9saXRlbmVzcyA9IENsckFyaWFMaXZlUG9saXRlbmVzcy5wb2xpdGUpOiB2b2lkIHtcbiAgICBpZiAocG9saXRlbmVzcyA9PT0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLm9mZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5hcmlhTGl2ZUVsZW1lbnQgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSB0aGlzLmNyZWF0ZUNvbnRhaW5lcigpO1xuICAgIH1cblxuICAgIG1lc3NhZ2UgPSB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSA/IG1lc3NhZ2UudGV4dENvbnRlbnQgOiBtZXNzYWdlO1xuXG4gICAgLy8gd2hlbiB0aGVyZSBpcyBubyBtZXNzYWdlIGRvIE5PVEhJTkchXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCBwb2xpdGVuZXNzKTtcblxuICAgIC8vIFRoaXMgMTAwbXMgdGltZW91dCBpcyBuZWNlc3NhcnkgZm9yIHNvbWUgYnJvd3NlciArIHNjcmVlbi1yZWFkZXIgY29tYmluYXRpb25zOlxuICAgIC8vIC0gQm90aCBKQVdTIGFuZCBOVkRBIG92ZXIgSUUxMSB3aWxsIG5vdCBhbm5vdW5jZSBhbnl0aGluZyB3aXRob3V0IGEgbm9uLXplcm8gdGltZW91dC5cbiAgICAvLyAtIFdpdGggQ2hyb21lIGFuZCBJRTExIHdpdGggTlZEQSBvciBKQVdTLCBhIHJlcGVhdGVkIChpZGVudGljYWwpIG1lc3NhZ2Ugd29uJ3QgYmUgcmVhZCBhXG4gICAgLy8gICBzZWNvbmQgdGltZSB3aXRob3V0IGNsZWFyaW5nIGFuZCB0aGVuIHVzaW5nIGEgbm9uLXplcm8gZGVsYXkuXG4gICAgLy8gKHVzaW5nIEpBV1MgMTcgYXQgdGltZSBvZiB0aGlzIHdyaXRpbmcpLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIC8vIFRoaXMgY2xlYXJUaW1lb3V0IHdpbGwgc3RvcCBhbGwgb2xkZXIgbWVzc2FnZXMgZnJvbSBhbm5vdW5jaW5nXG4gICAgICAvLyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgbWVzc2FnZXMgYXJlIGNvbW1pbmcgdG9vIGZhc3Qgd2UgZ29ubmEgdHJ5IHRvIGFwcGVuZCBvbmx5XG4gICAgICAvLyB0aGUgbGFzdCBvbmUuIFRoYXQncyB3aGF0IHRoZSBTUiB3aWxsIHRyeSB0byBkbyBhbnl3YXkuXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5wcmV2aW91c1RpbWVvdXQpO1xuICAgICAgdGhpcy5wcmV2aW91c1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSBtZXNzYWdlIGFzIHN0cmluZztcbiAgICAgIH0sIEFSSUFfTElWRV9USUNLKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBvbkRlc3Ryb3kgbGlmZSBjeWNsZSAtIG11c3Qgc3RvcCBhbGwgYWN0aXZlIHNldFRpbWVvdXRzIGFuZCByZW1vdmUgdGhlIEFyaWFMaXZlXG4gICAqIGNvbnRhaW5lciBmcm9tIHRoZSBkb2N1bWVudC5cbiAgICovXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnByZXZpb3VzVGltZW91dCk7XG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkgJiYgdGhpcy5hcmlhTGl2ZUVsZW1lbnQpIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyaWFMaXZlRWxlbWVudCk7XG4gICAgICB0aGlzLmFyaWFMaXZlRWxlbWVudCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBBcmlhTGl2ZSBET00gZWxlbWVudCBhcyBhIGxhc3QgY2hpbGQgb2YgdGhlIGRvY3VtZW50LlxuICAgKiBBZnRlciB0aGUgZWxlbWVudCBpcyBjcmVhdGVkLCB3ZSBnb25uYSBhcHBseSBDbGFyaXR5IGNsYXNzIHRvIGhpZGUgaXQgZnJvbVxuICAgKiB0aGUgc2NyZWVuIGFuZCBzZXQgdGhlIGBhcmlhLWxpdmVgIHBvbGl0bmVzcy5cbiAgICpcbiAgICogYGNsci1zci1vbmx5YCBpcyB0aGUgQ1NTIGNsYXNzIHRoYXQgaXMgdXNlZCB0byBoaWRlIHRoZSBlbGVtZW50IGZyb20gdGhlIHNjcmVlbi5cbiAgICpcbiAgICogQHJlbWFya1xuICAgKiBDYWxsaW5nIHRoaXMgbWV0aG9kIG11bHRpcGxlIHRpbWVzIHdpbGwgY3JlYXRlIG11bHRpcGxlIERPTSBFbGVtZW50cywgdGhhdFxuICAgKiB3b24ndCBiZSB0cmFja2VkIGFuZCB3aWxsIGJlIEdDIGFmdGVyIHRoZSBzZXJ2aWNlIGlzIGRlc3Ryb3llZC5cbiAgICpcbiAgICogQHJldHVybiBBcmlhTGl2ZSBjb250YWluZXIgYXMgSFRNTEVsZW1lbnRcbiAgICpcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlQ29udGFpbmVyKCk6IEhUTUxFbGVtZW50IHtcbiAgICBjb25zdCBhcmlhTGl2ZUVsZW1lbnQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgYXJpYUxpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCB0aGlzLmlkKTtcbiAgICAvLyBVc2UgY2xhcml0eSBzY3JlZW4gcmVhZGVyIGNsYXNzIHRvIGhpZGUgdGhlIGRvbSBlbGVtZW50XG4gICAgLy8gYW5kIGZpeCB0aGUgc2Nyb2xsYmFyIHNoYWtlXG4gICAgYXJpYUxpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2Nsci1zci1vbmx5Jyk7XG5cbiAgICBhcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWF0b21pYycsICd0cnVlJyk7XG4gICAgYXJpYUxpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1saXZlJywgQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLnBvbGl0ZSk7XG5cbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYXJpYUxpdmVFbGVtZW50KTtcblxuICAgIHJldHVybiBhcmlhTGl2ZUVsZW1lbnQ7XG4gIH1cbn1cbiJdfQ==